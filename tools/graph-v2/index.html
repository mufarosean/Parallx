<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Canvas Graph — Live</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{height:100%;overflow:hidden;background:#1a1a2e;font-family:-apple-system,"Segoe UI",sans-serif;color:#dcddde}
canvas{display:block;width:100%;height:100%;cursor:default}
canvas.grabbing{cursor:grabbing}

.top-bar{position:fixed;top:12px;left:50%;transform:translateX(-50%);display:flex;gap:8px;align-items:center;z-index:10;background:rgba(30,30,50,.85);backdrop-filter:blur(12px);border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:6px 14px}
.top-bar h1{font-size:14px;font-weight:600;letter-spacing:.3px;color:#c4b5fd}
.top-bar .sep{width:1px;height:16px;background:rgba(255,255,255,.12)}
.top-bar .stat{font-size:11px;color:#9ca3af}
.top-bar .stat b{color:#c4b5fd}
.top-bar .live{display:inline-block;width:6px;height:6px;border-radius:50%;background:#ef4444;margin-right:4px;animation:pulse 2s ease infinite}
.top-bar .live.connected{background:#22c55e}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}

.search-box{position:fixed;top:12px;left:12px;z-index:10}
.search-box input{width:200px;background:rgba(30,30,50,.85);backdrop-filter:blur(12px);border:1px solid rgba(255,255,255,.1);border-radius:8px;padding:7px 10px 7px 30px;color:#dcddde;font:12px -apple-system,"Segoe UI",sans-serif;outline:none;transition:border-color .2s}
.search-box input:focus{border-color:rgba(167,139,250,.5)}
.search-box input::placeholder{color:#6b7280}
.search-box svg{position:absolute;left:9px;top:50%;transform:translateY(-50%);pointer-events:none}

.controls{position:fixed;bottom:12px;left:12px;display:flex;gap:6px;z-index:10}
.controls button{background:rgba(30,30,50,.85);backdrop-filter:blur(12px);border:1px solid rgba(255,255,255,.1);border-radius:8px;padding:6px 12px;color:#9ca3af;font:11px -apple-system,"Segoe UI",sans-serif;cursor:pointer;transition:all .2s}
.controls button:hover{color:#e5e7eb;border-color:rgba(167,139,250,.4)}

.legend-panel{position:fixed;bottom:12px;right:12px;background:rgba(30,30,50,.85);backdrop-filter:blur(12px);border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:8px 12px;z-index:10;display:flex;flex-wrap:wrap;gap:8px 14px;max-width:460px}
.legend-panel .item{display:flex;align-items:center;gap:5px;font-size:10px;color:#9ca3af;white-space:nowrap}
.legend-panel .dot{width:8px;height:8px;border-radius:50%}

.inspector{position:fixed;top:52px;right:12px;width:300px;max-height:calc(100vh - 80px);background:rgba(22,22,40,.92);backdrop-filter:blur(16px);border:1px solid rgba(255,255,255,.08);border-radius:12px;overflow:hidden;z-index:10;display:none;flex-direction:column}
.inspector.open{display:flex}
.inspector .head{padding:12px 14px 10px;border-bottom:1px solid rgba(255,255,255,.06);display:flex;justify-content:space-between;align-items:flex-start}
.inspector .head .title{font-size:14px;font-weight:600;color:#e5e7eb}
.inspector .head .dir{font-size:10px;color:#8b5cf6;text-transform:uppercase;letter-spacing:.5px;margin-top:2px}
.inspector .head .close{background:none;border:none;color:#6b7280;cursor:pointer;font-size:16px;padding:0 2px}
.inspector .head .close:hover{color:#dcddde}
.inspector .body{padding:12px 14px;overflow-y:auto;flex:1}
.inspector .desc{font-size:12px;color:#9ca3af;line-height:1.5;margin-bottom:12px}
.inspector .section{margin-bottom:12px}
.inspector .section:last-child{margin:0}
.inspector .section h4{font-size:10px;color:#6b7280;text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px}
.inspector .exports{font-family:"Cascadia Mono",Consolas,monospace;font-size:11px;color:#a78bfa;line-height:1.8}
.inspector .dep-btn{display:block;width:100%;text-align:left;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.06);border-radius:6px;padding:5px 8px;margin-bottom:4px;cursor:pointer;transition:all .15s;color:#dcddde;font:12px -apple-system,"Segoe UI",sans-serif}
.inspector .dep-btn:hover{border-color:rgba(167,139,250,.4);background:rgba(167,139,250,.08)}
.inspector .dep-btn .sub{font-size:10px;color:#6b7280;font-family:"Cascadia Mono",monospace;display:block;margin-top:1px}
.inspector .ext{font-family:"Cascadia Mono",Consolas,monospace;font-size:10px;color:#6b7280;line-height:1.8}
.inspector .empty{font-size:11px;color:#4b5563;font-style:italic}

/* Toast notification for live updates */
.toast{position:fixed;top:52px;left:50%;transform:translateX(-50%) translateY(-40px);background:rgba(34,197,94,.15);border:1px solid rgba(34,197,94,.3);border-radius:8px;padding:6px 14px;font-size:11px;color:#86efac;z-index:20;opacity:0;transition:all .3s ease;pointer-events:none}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
</style>
</head>
<body>
<canvas id="c"></canvas>

<div class="search-box">
  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#6b7280" stroke-width="2"><circle cx="11" cy="11" r="7"/><path d="m21 21-4.35-4.35"/></svg>
  <input id="search" placeholder="Filter files..." autocomplete="off" spellcheck="false">
</div>

<div class="top-bar">
  <span class="live" id="liveIndicator"></span>
  <h1>Canvas Graph</h1>
  <div class="sep"></div>
  <div class="stat"><b id="nodeCount">0</b> files</div>
  <div class="sep"></div>
  <div class="stat"><b id="edgeCount">0</b> links</div>
  <div class="sep"></div>
  <div class="stat" id="statusText">connecting…</div>
</div>

<div class="controls">
  <button onclick="fitAll()">Fit All</button>
  <button id="physBtn" onclick="togglePhysics()">Pause Physics</button>
  <button id="edgesBtn" onclick="toggleEdges()">Hide Edges</button>
  <button onclick="releaseAll()">Unpin All</button>
</div>

<div class="legend-panel" id="legend"></div>

<div class="inspector" id="inspector">
  <div class="head">
    <div><div class="title" id="insTitle"></div><div class="dir" id="insDir"></div></div>
    <button class="close" onclick="closeInspector()">&times;</button>
  </div>
  <div class="body" id="insBody"></div>
</div>

<div class="toast" id="toast"></div>

<script>
(()=>{
/* ═══════════════════════════════════════════
   CONFIG
   ═══════════════════════════════════════════ */
const DIR_COLORS={
  root:'#7c9cbf',config:'#4db6ac',dnd:'#78909c',extensions:'#ef5350',
  plugins:'#ab47bc',menus:'#ffa726',handles:'#ec407a',header:'#42a5f5',
  invariants:'#78909c',math:'#78909c',mutations:'#66bb6a',migrations:'#546e7a',
  pickers:'#ffca28'
};
const ENTRY_COLOR='#f9a825';
const DEFAULT_COLOR='#78909c';
const REPEL=7000,ATTRACT=.035,REST=140,DAMP=.86,GRAV=.0008,CPULL=.004;

/* ═══════════════════════════════════════════
   GRAPH STATE
   ═══════════════════════════════════════════ */
let nodes=[], edges=[], byId=new Map();
let physicsOn=true, showEdges=true, selected=null, hovered=null, drag=null;
const CX=900,CY=650;

const cvs=document.getElementById('c');
const ctx=cvs.getContext('2d');
let dpr=Math.max(1,devicePixelRatio||1);
let view={x:0,y:0,s:1};
let firstLoad=true;

/* ═══════════════════════════════════════════
   APPLY GRAPH DATA from server
   ═══════════════════════════════════════════ */
function applyGraph(data){
  const oldById=byId;
  const newById=new Map();
  const newNodes=[];

  for(const f of data.nodes){
    const existing=oldById.get(f.id);
    const color=f.id==='main'?ENTRY_COLOR:(DIR_COLORS[f.dir]||DEFAULT_COLOR);
    if(existing){
      // Preserve position, velocity, pin state
      existing.path=f.path;existing.dir=f.dir;existing.desc=f.desc;
      existing.exports=f.exports;existing.imports=f.imports;
      existing.external=f.external;existing.radius=f.radius;
      existing.color=color;existing.match=true;
      newNodes.push(existing);
      newById.set(f.id,existing);
    } else {
      // New node — place near cluster center
      const cl=clusterCenter(f.dir);
      const a=Math.random()*Math.PI*2, r=Math.random()*60;
      const n={...f,
        x:cl.x+Math.cos(a)*r, y:cl.y+Math.sin(a)*r,
        vx:0,vy:0,pinned:false,
        color, match:true
      };
      newNodes.push(n);
      newById.set(f.id,n);
    }
  }

  nodes=newNodes;
  byId=newById;
  edges=data.edges.filter(e=>byId.has(e.source)&&byId.has(e.target));

  document.getElementById('nodeCount').textContent=nodes.length;
  document.getElementById('edgeCount').textContent=edges.length;

  // Update selected if it was deleted
  if(selected&&!byId.has(selected.id)){selected=null;document.getElementById('inspector').classList.remove('open')}

  // Apply search filter
  applyFilter();

  // Update legend
  buildLegend();

  if(firstLoad){
    // Run physics settling
    for(let i=0;i<280;i++) tick();
    fitAll();
    firstLoad=false;
  }
}

function clusterCenter(dir){
  const offsets={
    root:{x:0,y:0},config:{x:380,y:-300},extensions:{x:-400,y:80},
    plugins:{x:420,y:160},menus:{x:140,y:350},handles:{x:-100,y:-350},
    header:{x:400,y:-80},dnd:{x:-400,y:-280},invariants:{x:260,y:200},
    math:{x:-240,y:-280},mutations:{x:-200,y:350},migrations:{x:500,y:300},
    pickers:{x:-300,y:-150}
  };
  const o=offsets[dir]||{x:(Math.random()-.5)*400,y:(Math.random()-.5)*400};
  return{x:CX+o.x,y:CY+o.y};
}

function buildLegend(){
  const dirs=new Set(nodes.map(n=>n.dir));
  const el=document.getElementById('legend');
  el.innerHTML=[...dirs].sort().map(d=>{
    const col=d==='root'&&nodes.some(n=>n.id==='main')?ENTRY_COLOR:(DIR_COLORS[d]||DEFAULT_COLOR);
    return `<div class="item"><div class="dot" style="background:${col}"></div>${d}</div>`;
  }).join('');
}

/* ═══════════════════════════════════════════
   PHYSICS
   ═══════════════════════════════════════════ */
function tick(){
  if(!physicsOn) return;
  for(let i=0;i<nodes.length;i++){
    const a=nodes[i];
    for(let j=i+1;j<nodes.length;j++){
      const b=nodes[j];
      let dx=a.x-b.x,dy=a.y-b.y,d2=dx*dx+dy*dy;
      if(d2<1)d2=1;if(d2>600000)continue;
      const dist=Math.sqrt(d2),f=REPEL/d2;
      const fx=dx/dist*f,fy=dy/dist*f;
      if(!a.pinned){a.vx+=fx;a.vy+=fy}
      if(!b.pinned){b.vx-=fx;b.vy-=fy}
    }
  }
  if(showEdges) for(const e of edges){
    const a=byId.get(e.source),b=byId.get(e.target);
    if(!a||!b)continue;
    const dx=b.x-a.x,dy=b.y-a.y,dist=Math.sqrt(dx*dx+dy*dy)||1;
    const f=ATTRACT*(dist-REST);
    if(!a.pinned){a.vx+=dx/dist*f;a.vy+=dy/dist*f}
    if(!b.pinned){b.vx-=dx/dist*f;b.vy-=dy/dist*f}
  }
  const cls={};
  for(const n of nodes){if(!cls[n.dir])cls[n.dir]={sx:0,sy:0,c:0};cls[n.dir].sx+=n.x;cls[n.dir].sy+=n.y;cls[n.dir].c++}
  for(const n of nodes){
    if(n.pinned)continue;
    const cl=cls[n.dir];
    n.vx+=(cl.sx/cl.c-n.x)*CPULL;n.vy+=(cl.sy/cl.c-n.y)*CPULL;
    n.vx+=(CX-n.x)*GRAV;n.vy+=(CY-n.y)*GRAV;
    n.vx*=DAMP;n.vy*=DAMP;
    n.x+=n.vx;n.y+=n.vy;
  }
}

/* ═══════════════════════════════════════════
   DRAWING
   ═══════════════════════════════════════════ */
function resize(){dpr=Math.max(1,devicePixelRatio||1);cvs.width=Math.floor(cvs.clientWidth*dpr);cvs.height=Math.floor(cvs.clientHeight*dpr)}

function fitAll(){
  const w=cvs.clientWidth,h=cvs.clientHeight;
  let x0=1e9,y0=1e9,x1=-1e9,y1=-1e9;
  for(const n of nodes){if(!n.match)continue;x0=Math.min(x0,n.x-40);y0=Math.min(y0,n.y-40);x1=Math.max(x1,n.x+40);y1=Math.max(y1,n.y+40)}
  if(!isFinite(x0)){x0=-100;y0=-100;x1=100;y1=100}
  const s=Math.min((w-80)/(x1-x0),(h-80)/(y1-y0),1.5);
  view.s=s;view.x=w/2-(x0+x1)/2*s;view.y=h/2-(y0+y1)/2*s;
}
window.fitAll=()=>{fitAll();draw()};
window.togglePhysics=()=>{physicsOn=!physicsOn;document.getElementById('physBtn').textContent=physicsOn?'Pause Physics':'Resume Physics'};
window.toggleEdges=()=>{
  showEdges=!showEdges;
  document.getElementById('edgesBtn').textContent=showEdges?'Hide Edges':'Show Edges';
  if(!showEdges){
    snapToClusters();
  } else {
    // Release all pins, let physics pull everything back together
    for(const n of nodes){n.pinned=false;n.vx=0;n.vy=0}
    physicsOn=true;
    document.getElementById('physBtn').textContent='Pause Physics';
  }
};
window.releaseAll=()=>{for(const n of nodes)n.pinned=false};

/** Arrange nodes in neat, non-overlapping cluster circles in a grid. */
function snapToClusters(){
  // Group by directory
  const groups={};
  for(const n of nodes){if(!groups[n.dir])groups[n.dir]=[];groups[n.dir].push(n)}

  // Sort dirs: largest group first
  const dirNames=Object.keys(groups).sort((a,b)=>groups[b].length-groups[a].length);

  // Size each cluster
  const clusterMeta=[];
  for(const dir of dirNames){
    const ns=groups[dir];
    const padding=22;
    const maxR=Math.max(...ns.map(n=>n.radius));
    const circumNeeded=ns.length*(maxR*2+padding);
    const ringR=ns.length===1?0:ns.length===2?35:Math.max(45,circumNeeded/(2*Math.PI));
    const outerR=ringR+maxR+20;
    clusterMeta.push({dir,nodes:ns,ringR,outerR});
  }

  // Lay out in rows — pack left-to-right, wrap when row gets too wide
  const GAP=50;
  const maxRowWidth=Math.max(1200, clusterMeta.reduce((s,c)=>s+c.outerR*2,0)*0.55);
  const rows=[]; // array of arrays of clusterMeta
  let curRow=[],curRowWidth=0;
  for(const cm of clusterMeta){
    const w=cm.outerR*2;
    if(curRow.length>0 && curRowWidth+GAP+w>maxRowWidth){
      rows.push(curRow);
      curRow=[cm];curRowWidth=w;
    } else {
      if(curRow.length>0) curRowWidth+=GAP;
      curRow.push(cm);curRowWidth+=w;
    }
  }
  if(curRow.length) rows.push(curRow);

  // Position each row, centered horizontally
  let totalHeight=0;
  for(const row of rows){
    const rowH=Math.max(...row.map(c=>c.outerR*2));
    totalHeight+=rowH;
  }
  totalHeight+=(rows.length-1)*GAP;

  let curY=CY-totalHeight/2;
  for(const row of rows){
    const rowH=Math.max(...row.map(c=>c.outerR*2));
    const rowW=row.reduce((s,c)=>s+c.outerR*2,0)+(row.length-1)*GAP;
    let curX=CX-rowW/2;
    for(const cm of row){
      cm.cx=curX+cm.outerR;
      cm.cy=curY+rowH/2;
      curX+=cm.outerR*2+GAP;
    }
    curY+=rowH+GAP;
  }

  // Place nodes in a ring inside their cluster circle
  for(const cm of clusterMeta){
    const ns=cm.nodes;
    // Sort nodes alphabetically for consistent layout
    ns.sort((a,b)=>a.path.localeCompare(b.path));
    if(ns.length===1){
      ns[0].x=cm.cx;ns[0].y=cm.cy;ns[0].vx=0;ns[0].vy=0;ns[0].pinned=true;
    } else {
      for(let i=0;i<ns.length;i++){
        const a=(i/ns.length)*Math.PI*2-Math.PI/2;
        ns[i].x=cm.cx+Math.cos(a)*cm.ringR;
        ns[i].y=cm.cy+Math.sin(a)*cm.ringR;
        ns[i].vx=0;ns[i].vy=0;ns[i].pinned=true;
      }
    }
  }
  // Pause physics while in cluster mode
  physicsOn=false;
  document.getElementById('physBtn').textContent='Resume Physics';
  fitAll();
}

function s2w(sx,sy){return{x:(sx-view.x)/view.s,y:(sy-view.y)/view.s}}
function rgba(hex,a){const c=hex.replace('#','');return `rgba(${parseInt(c.slice(0,2),16)},${parseInt(c.slice(2,4),16)},${parseInt(c.slice(4,6),16)},${a})`}

function hitTest(sx,sy){
  const p=s2w(sx,sy);
  let best=null,bd=Infinity;
  for(const n of nodes){if(!n.match)continue;const d=Math.hypot(n.x-p.x,n.y-p.y);if(d<n.radius+8/Math.max(.3,view.s)&&d<bd){best=n;bd=d}}
  return best;
}
function getConn(id){const s=new Set();for(const e of edges){if(e.source===id)s.add(e.target);if(e.target===id)s.add(e.source)}return s}

function draw(){
  const w=cvs.clientWidth,h=cvs.clientHeight;
  ctx.setTransform(dpr,0,0,dpr,0,0);
  ctx.clearRect(0,0,w,h);
  ctx.save();
  ctx.translate(view.x,view.y);
  ctx.scale(view.s,view.s);

  const conn=selected?getConn(selected.id):new Set();
  const hasSel=!!selected;

  // Cluster halos
  const clm={};
  for(const n of nodes){if(!n.match)continue;if(!clm[n.dir])clm[n.dir]=[];clm[n.dir].push(n)}
  for(const [dir,ns] of Object.entries(clm)){
    if(ns.length<2)continue;
    let cx=0,cy=0;for(const n of ns){cx+=n.x;cy+=n.y}cx/=ns.length;cy/=ns.length;
    let mr=0;for(const n of ns)mr=Math.max(mr,Math.hypot(n.x-cx,n.y-cy));
    const col=DIR_COLORS[dir]||DEFAULT_COLOR;
    ctx.beginPath();ctx.arc(cx,cy,mr+55,0,Math.PI*2);
    ctx.fillStyle=rgba(col,.025);ctx.strokeStyle=rgba(col,.05);ctx.lineWidth=1;
    ctx.fill();ctx.stroke();
    if(view.s>.18){
      const fontSize=Math.round(11/Math.max(.4,view.s));
      const maxNodeR=Math.max(...ns.map(n=>n.radius));
      const labelOffset=mr+maxNodeR+fontSize+12;
      ctx.font=`600 ${fontSize}px -apple-system,"Segoe UI",sans-serif`;
      ctx.fillStyle=rgba(col,.35);ctx.textAlign='center';
      ctx.fillText(dir==='root'?'root':dir+'/',cx,cy-labelOffset);
    }
  }

  // Edges
  if(showEdges) for(const e of edges){
    const a=byId.get(e.source),b=byId.get(e.target);
    if(!a||!b||!a.match||!b.match)continue;
    const hl=hasSel&&(e.source===selected.id||e.target===selected.id);
    const dim=hasSel&&!hl;
    if(dim&&view.s<.35)continue;
    const dx=b.x-a.x,dy=b.y-a.y,dist=Math.hypot(dx,dy)||1;
    const bend=Math.min(30,dist*.08);
    const mx=(a.x+b.x)/2-dy/dist*bend,my=(a.y+b.y)/2+dx/dist*bend;
    ctx.beginPath();ctx.moveTo(a.x,a.y);ctx.quadraticCurveTo(mx,my,b.x,b.y);
    if(hl){ctx.strokeStyle=rgba(selected.color,.45);ctx.lineWidth=2.2;ctx.shadowColor=rgba(selected.color,.2);ctx.shadowBlur=10}
    else{ctx.strokeStyle=dim?'rgba(255,255,255,.015)':'rgba(255,255,255,.055)';ctx.lineWidth=1;ctx.shadowBlur=0}
    ctx.stroke();ctx.shadowBlur=0;
    if(hl||(!dim&&view.s>.3)){
      const t=.8;
      const px=a.x*(1-t)*(1-t)+mx*2*(1-t)*t+b.x*t*t;
      const py=a.y*(1-t)*(1-t)+my*2*(1-t)*t+b.y*t*t;
      const t2=t+.02;
      const px2=a.x*(1-t2)*(1-t2)+mx*2*(1-t2)*t2+b.x*t2*t2;
      const py2=a.y*(1-t2)*(1-t2)+my*2*(1-t2)*t2+b.y*t2*t2;
      const ang=Math.atan2(py2-py,px2-px),sz=hl?6:3.5;
      ctx.beginPath();
      ctx.moveTo(px+Math.cos(ang)*sz,py+Math.sin(ang)*sz);
      ctx.lineTo(px+Math.cos(ang+2.5)*sz*.6,py+Math.sin(ang+2.5)*sz*.6);
      ctx.lineTo(px+Math.cos(ang-2.5)*sz*.6,py+Math.sin(ang-2.5)*sz*.6);
      ctx.closePath();
      ctx.fillStyle=hl?rgba(selected.color,.45):'rgba(255,255,255,.06)';ctx.fill();
    }
  }

  // Nodes
  for(const n of nodes){
    if(!n.match)continue;
    const isSel=selected&&n.id===selected.id;
    const isHov=hovered&&n.id===hovered.id;
    const isConn=hasSel&&conn.has(n.id);
    const dim=hasSel&&!isSel&&!isConn;
    const r=n.radius*(isSel?1.12:isHov?1.06:1);
    if(isSel||isConn){
      const g=ctx.createRadialGradient(n.x,n.y,r*.5,n.x,n.y,r+10);
      g.addColorStop(0,rgba(n.color,isSel?.2:.08));g.addColorStop(1,'rgba(0,0,0,0)');
      ctx.beginPath();ctx.arc(n.x,n.y,r+10,0,Math.PI*2);ctx.fillStyle=g;ctx.fill();
    }
    ctx.beginPath();ctx.arc(n.x,n.y,r,0,Math.PI*2);
    ctx.fillStyle=rgba(n.color,dim?.1:.8);ctx.fill();
    ctx.lineWidth=isSel?2.5:isHov?1.8:1;
    ctx.strokeStyle=isSel?'rgba(255,255,255,.85)':isHov?'rgba(255,255,255,.5)':rgba(n.color,dim?.08:.3);
    ctx.stroke();
    if(n.pinned&&!dim){ctx.beginPath();ctx.arc(n.x+r*.65,n.y-r*.65,2.5,0,Math.PI*2);ctx.fillStyle='rgba(255,255,255,.5)';ctx.fill()}
    const show=view.s>.28||isSel||isHov||isConn;
    if(show&&!dim){
      const name=n.path.includes('/')?n.path.split('/').pop():n.path;
      const fs_=Math.max(7,Math.min(11,10/Math.max(.45,view.s)));
      ctx.font=`${isSel?'600':'400'} ${fs_}px "Cascadia Mono",Consolas,monospace`;
      const tw=ctx.measureText(name).width;
      const px=n.x,py=n.y-r-fs_*.6-5;
      const pw=tw+8,ph=fs_+4;
      const rr=3,bx=px-pw/2,by=py-ph/2;
      ctx.beginPath();ctx.moveTo(bx+rr,by);ctx.lineTo(bx+pw-rr,by);ctx.quadraticCurveTo(bx+pw,by,bx+pw,by+rr);ctx.lineTo(bx+pw,by+ph-rr);ctx.quadraticCurveTo(bx+pw,by+ph,bx+pw-rr,by+ph);ctx.lineTo(bx+rr,by+ph);ctx.quadraticCurveTo(bx,by+ph,bx,by+ph-rr);ctx.lineTo(bx,by+rr);ctx.quadraticCurveTo(bx,by,bx+rr,by);
      ctx.fillStyle=isSel?'rgba(30,30,55,.92)':'rgba(26,26,46,.78)';ctx.fill();
      ctx.fillStyle=isSel?'#fff':isConn?'#ddd':'#bbb';
      ctx.textAlign='center';ctx.textBaseline='middle';
      ctx.fillText(name,px,py);
    }
  }
  ctx.restore();
}

/* ═══════════════════════════════════════════
   INSPECTOR
   ═══════════════════════════════════════════ */
function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}
function openInspector(n){
  selected=n;
  document.getElementById('inspector').classList.add('open');
  document.getElementById('insTitle').textContent=n.path.includes('/')?n.path.split('/').pop():n.path;
  document.getElementById('insDir').textContent='src/built-in/canvas/'+n.path;
  const deps=(n.imports||[]).filter(id=>byId.has(id));
  const usedBy=nodes.filter(o=>(o.imports||[]).includes(n.id));
  const ext=n.external||[];
  let html=`<div class="desc">${esc(n.desc)}</div>`;
  html+=`<div class="section"><h4>Exports (${(n.exports||[]).length})</h4><div class="exports">${(n.exports||[]).map(e=>`<div>${esc(e)}</div>`).join('')||'<div class="empty">none</div>'}</div></div>`;
  html+=`<div class="section"><h4>Depends On (${deps.length})</h4>`;
  if(deps.length) html+=deps.map(id=>{const t=byId.get(id);return `<button class="dep-btn" data-id="${id}"><span style="color:${t.color}">\u25CF</span> ${esc(t.path.includes('/')?t.path.split('/').pop():t.path)}<span class="sub">${esc(t.path)}</span></button>`}).join('');
  else html+='<div class="empty">Leaf — no canvas dependencies</div>';
  html+=`</div>`;
  html+=`<div class="section"><h4>Used By (${usedBy.length})</h4>`;
  if(usedBy.length) html+=usedBy.map(o=>`<button class="dep-btn" data-id="${o.id}"><span style="color:${o.color}">\u25CF</span> ${esc(o.path.includes('/')?o.path.split('/').pop():o.path)}<span class="sub">${esc(o.path)}</span></button>`).join('');
  else html+='<div class="empty">Not imported by any canvas file</div>';
  html+=`</div>`;
  if(ext.length) html+=`<div class="section"><h4>External (${ext.length})</h4><div class="ext">${ext.map(e=>`<div>${esc(e)}</div>`).join('')}</div></div>`;
  document.getElementById('insBody').innerHTML=html;
  for(const btn of document.querySelectorAll('.dep-btn')){
    btn.onclick=()=>{const t=byId.get(btn.dataset.id);if(t){view.x=cvs.clientWidth/2-t.x*view.s;view.y=cvs.clientHeight/2-t.y*view.s;openInspector(t);draw()}};
  }
  draw();
}
function closeInspector(){selected=null;document.getElementById('inspector').classList.remove('open');draw()}
window.closeInspector=closeInspector;

/* ═══════════════════════════════════════════
   INPUT
   ═══════════════════════════════════════════ */
function pt(ev){const r=cvs.getBoundingClientRect();return{x:ev.clientX-r.left,y:ev.clientY-r.top}}

cvs.addEventListener('pointerdown',ev=>{
  const p=pt(ev),node=hitTest(p.x,p.y);
  if(node){drag={type:'node',node,sx:p.x,sy:p.y,moved:false};node.pinned=true}
  else{drag={type:'pan',sx:p.x,sy:p.y,vx:view.x,vy:view.y,moved:false}}
  cvs.setPointerCapture(ev.pointerId);
});
cvs.addEventListener('pointermove',ev=>{
  const p=pt(ev);
  if(drag){
    const dx=p.x-drag.sx,dy=p.y-drag.sy;
    if(Math.abs(dx)>2||Math.abs(dy)>2)drag.moved=true;
    if(drag.type==='pan'){view.x=drag.vx+dx;view.y=drag.vy+dy;cvs.classList.add('grabbing')}
    else{const w=s2w(p.x,p.y);drag.node.x=w.x;drag.node.y=w.y;drag.node.vx=0;drag.node.vy=0}
    return;
  }
  const node=hitTest(p.x,p.y);
  if(hovered!==node){hovered=node;cvs.style.cursor=node?'pointer':'default'}
});
cvs.addEventListener('pointerup',ev=>{
  cvs.classList.remove('grabbing');
  if(drag&&!drag.moved){
    if(drag.type==='node'){openInspector(drag.node);drag.node.pinned=false}
    else closeInspector();
  }
  drag=null;
});
cvs.addEventListener('wheel',ev=>{
  ev.preventDefault();
  const p=pt(ev),w=s2w(p.x,p.y);
  view.s=Math.max(.06,Math.min(4,view.s*Math.exp(-ev.deltaY*.0015)));
  view.x=p.x-w.x*view.s;view.y=p.y-w.y*view.s;
},{passive:false});
cvs.addEventListener('dblclick',ev=>{
  const p=pt(ev),n=hitTest(p.x,p.y);
  if(n){view.x=cvs.clientWidth/2-n.x*view.s;view.y=cvs.clientHeight/2-n.y*view.s;openInspector(n)}
});

/* ═══════════════════════════════════════════
   SEARCH
   ═══════════════════════════════════════════ */
function applyFilter(){
  const q=(document.getElementById('search').value||'').trim().toLowerCase();
  for(const n of nodes) n.match=!q||n.id.toLowerCase().includes(q)||n.path.toLowerCase().includes(q)||n.dir.toLowerCase().includes(q)||(n.desc||'').toLowerCase().includes(q);
}
document.getElementById('search').addEventListener('input',()=>{applyFilter();draw()});

/* ═══════════════════════════════════════════
   TOAST
   ═══════════════════════════════════════════ */
let toastTimer=null;
function showToast(msg){
  const el=document.getElementById('toast');
  el.textContent=msg;el.classList.add('show');
  if(toastTimer)clearTimeout(toastTimer);
  toastTimer=setTimeout(()=>el.classList.remove('show'),2500);
}

/* ═══════════════════════════════════════════
   SSE CONNECTION
   ═══════════════════════════════════════════ */
const indicator=document.getElementById('liveIndicator');
const statusText=document.getElementById('statusText');
let reconnectDelay=1000;

function connectSSE(){
  statusText.textContent='connecting…';
  indicator.classList.remove('connected');

  const es=new EventSource('/events');

  es.onopen=()=>{
    indicator.classList.add('connected');
    statusText.textContent='live';
    reconnectDelay=1000;
  };

  es.onmessage=(ev)=>{
    try{
      const data=JSON.parse(ev.data);
      const prevCount=nodes.length;
      applyGraph(data);
      if(!firstLoad && nodes.length!==prevCount){
        showToast(`Graph updated — ${nodes.length} files, ${edges.length} links`);
      } else if(!firstLoad){
        showToast('Graph refreshed');
      }
    }catch(err){console.error('SSE parse error:',err)}
  };

  es.onerror=()=>{
    es.close();
    indicator.classList.remove('connected');
    statusText.textContent='reconnecting…';
    setTimeout(connectSSE,reconnectDelay);
    reconnectDelay=Math.min(reconnectDelay*1.5,10000);
  };
}
connectSSE();

/* ═══════════════════════════════════════════
   ANIMATION LOOP
   ═══════════════════════════════════════════ */
function loop(){tick();draw();requestAnimationFrame(loop)}
window.addEventListener('resize',resize);
resize();
requestAnimationFrame(loop);
})();
</script>
</body>
</html>
